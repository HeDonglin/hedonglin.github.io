---
title: Http应用层协议
date: 2017-06-19 11:11:48
categories: 服务器
tags: 协议
---
## http协议作用
不涉及数据包传输，主要规定客户端与服务端之间的通讯格式，默认采用80端口
## http技术方向图
<img src="/images/http-2.png" alt="http-2.png">
*****

## http发展历程
### http/0.9 ***1991年*** `GET`
### http/1.0 ***1996年5月*** `GET` `POST` `HEAD`
* 缺点：每个TCP连接只能发送一个请求，发送完毕关闭连接，其他请求必须重新新建连接
* 解决：connection:keep-alive(非标准)要求服务器不要关闭TCP连接

### http/1.1 ***1997年1月*** `GET` `POST` `HEAD` `OPTIONS` `DELETE` `PUT` `CONNECT` `TRACE` 
* 优点：持续连接(默认不关闭，没活动自动关闭)，管道机制(同时发送多个请求)，分块传输编码(Transfer-Encoding:chunked)
* 缺点：队头堵塞也就是排队回应
* 解决：减少请求数，同时多开持续连接；

### SPDY协议 ***2009年*** 
谷歌自行研发的协议主要解决HTTP/1.1 效率不高的问题，HTTP/2 的基础
### http/2   ***2015年***
* 二进制协议
* 多工
* 数据流
* 头信息压缩
* 服务器推送
*****

## 请求格式
<img src="/images/http-15.png" alt="http-15.png">
### 请求行:（请求方法 URL HTTP协议版本）
```js
GET     请求指定的页面信息，并返回实体主体。
POST    向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST请求可能会导致新的资源的建立和/或已有资源的修改。
HEAD    类似于get请求，只不过返回的响应中没有具体的内容，用于获取报头
OPTIONS 允许客户端查看服务器的性能。
DELETE  请求服务器删除指定的页面。
PUT     从客户端向服务器传送的数据取代指定的文档的内容。
CONNECT HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。
TRACE   回显服务器收到的请求，主要用于测试或诊断。
```

### 请求头部：（属性：值）
### 空行（回车换行）
### 请求数据：（数据）


## 回应格式
### 状态行：http协议版本号，状态码，状态消息
### 消息报头
### 空行
### 响应正文
*****

## 字段
`User-Agent`:客户端的浏览器信息
`Connection`：close表示使用短连接，Keep-Alive表示客户端支持持久连接,以便请求复用
`Date`：消息发送的时间，时间的描述格式由rfc822定义。例如，Date:Mon,31Dec200104:25:57GMT。Date描述的时间表示世界标准时，换算成本地时间，需要知道用户所在的时区。 
`Accept-Language`：客户端支持的语言
`Cache-Control`：客户端是否支持cache,no-cache表示客户端不支持cache，如max-age=3600，告诉User Agent 该请求的响应结果在多长时间内有效，在有效期内，当用户再次需要访问时，直接从客户端本地提取，不需要访问服务器。
　　Public指示响应可被任何缓存区缓存。
　　Private指示对于单个用户的整个或部分响应消息，不能被共享缓存处理。这允许服务器仅仅描述当用户的部分响应消息，此响应消息对于其他用户的请求无效。  
　　no-cache指示请求或响应消息不能缓存  
　　no-store用于防止重要的信息被无意的发布。在请求消息中发送将使得请求和响应消息都不使用缓存。
　　max-age指示客户机可以接收生存期不大于指定时间（以秒为单位）的响应。
　　min-fresh指示客户机可以接收响应时间小于当前时间加上指定时间的响应。
　　max-stale指示客户机可以接收超出超时期间的响应消息。如果指定max-stale消息的值，那么客户机可以接收超出超时期指定值之内的响应消息
`Pragma`头域用来包含实现特定的指令，最常用的是Pragma:no-cache。在HTTP/1.1协议中，它的含义和Cache-Control:no-cache相同
`Referer`：用以告诉服务器该请求来自于哪个URL，可以用追踪用户的WEB访问路径
`If-Modified-Since`: 如果请求消息包含If-Modified-Since标题域，GET方法的语法就变成“条件GET”，即“（conditional GET）”。 条件GET方法可以对指定资源进行判断，如果它在If-Modified-Since标题域中的指定日期后发生了更新，才启动传输，否则不传输。这种条件GET允许被缓存的实体在不必经过多次请求或不必要的数据传输就能进行刷新，从而有助于降低网络负载。
`Content-Type`:服务器回应客户端数据是什么格式,MIME type,一级类型和二级类型，之间用斜杠分隔;
`Accept`:客户端请求声明自己可以接受哪些数据格式；
`Accept-Encoding`:客户端请求时用于说明自己可以接受的压缩方法；
`Content-Encoding`:数据的压缩方法；
`Content-Length`:3000;本次回应的长度是3000字节；后面的字节就是下一个回应了；
`Transfer-Encoding`:回应将由数量未定的数据块组成；
`Last-Modified`: Sun, 03 Dec 2008 23:52:56 GMT
`Expires`：该请求的响应结果在什么时间失效，在没有失效之前，代理可直接从缓存中返回以前的响应结果。
`Host`：指定请求资源的Intenet主机和端口号，必须表示请求url的原始服务器或网关的位置。HTTP/1.1请求必须包含主机头域，否则系统会以400状态码返回。  
`Range`Range头域可以请求实体的一个或者多个子范围
`Location`用于重定向接收者到一个新URI地址。
`Server`包含处理请求的原始服务器的软件信息。此域能包含多个产品标识和注释，产品标识一般按照重要性排序。
`Last-modified`指定服务器上保存内容的最后修订时间。

*****

## TCP(Transmission Control Protocol)传输控制协议,位于传输层
`Sequence number`顺序号码(下面简写为：SeqNum) 
`Acknowledge number`确认号码(下面简写为：AckNum)
`SYN`(synchronous)表示建立连接 
`ACK`(acknowledgement)表示响应
`URG`(urgent)表示有紧急的数据传送（URG=1,优先发送紧急数据，并优先提交，比如一个终止命令） 
`PSH`(push)表示推送（PSH=1发送方立即发送缓冲区中的数据，不等待后续数据构成更大的段，接收方立即提交该数据而不等待后续数据的到达） `FIN`(finish)表示关闭连接
`RST`(reset)表示连接重置 
*****
## 三次握手，建立一个连接
<img src="/images/http-4.png" alt="http-4.png"> 
**第一次握手**：客户端发送（`SYN=1`+随机生成的`SeqNum`）数据包到服务器，服务器由`SYN=1`知道客户端要求建立联机；
**第二次握手**：服务器收到请求确认`SYN=1`，就向客户端发送{,`SYN=1`,`ACK=1`,`AckNum(客户端SeqNum+1)`，随机生成的`SeqNum`}数据包
**第三次握手**：客户端收到回应检查(AckNum客户端`SeqNum+1`)是否正确，ACK是否为1，正确则再次发送`AckNum(服务器seqNum+1)`,`ACK=1`,服务器收到后并确认(服务器seqNum+1),ACK=1是否正确； 
**为什么需要三次握手？**
因为请求有可能会丢失和延迟，请求丢失一般采用了超时重传，如果请求并没有丢失而是延迟到达，那么就会出现重复连接，还有一种情况连接关闭后请求才到达，那么会导致服务器一直在等待，从而浪费资源；
*****

## 四次挥手，断开一个连接
<img src="/images/http-5.png" alt="http-5.png">
**第一次挥手**：客户端发送(`FIN=1`+随机生成的`SeqNum`序号)断开连接请求到服务器并等待服务器确认；
**第二次挥手**：服务器确认后发出确认`ACK=1`+`AckNum(SeqNum+1)`包，客户端收到并确认后处于等待状态，等待服务器发送断开请求，此时客户端不再发送数据但可以接受数据；
**第三次挥手**：服务器发送完数据后，接着发送断开请求`FIN=1`;`ACK=1`，`SeqNum`;`AckNum(SeqNum+1)`给客户端；
**第四次挥手**：客户端收到并确认后发送`ACK=1`;`AckNum(SeqNum+1)`确认包给服务器，接着等待M秒（可修改）后关闭连接；服务器收到确认包后也关闭连接；
**为什么采用四次挥手？**
因为单方面断开连接随时可能丢失数据，比如A、B两个主机，A发出断开连接请求并停止接受该连接的数据，那么B没没收到断开连接请求之前随时可能向主机A发送数据，而主机A已经停止接受数据所以会造成数据丢失；所以采用了两个方向上分别断开连接操作，也就是四次挥手；
## 抓包分析
### Wireshark分析工具
wireshark只能查看封包，而不能修改封包的内容，或者发送封包。
**协议过滤**
　　`TCP` `HTTP`
**域名过滤**
　　http.host==hedonglin.com
**IP过滤**
　　ip.addr ==192.168.1.1；显示所有目标或源地址是192.168.1.1；
　　ip.dst==192.168.1.1；显示目标地址是192.168.1.1
　　ip.src ==192.168.1.1 显示源地址是192.168.1.1
**端口过滤**
　　tcp.port ==目标端口80
**请求方法过滤**
　　http.request.method=="GET"
**逻辑运算**
　　and or not
**例子**
　　http and ip.addr == 119.75.216.20 and tcp.port == 80
### 查看域名对应的ip地址
　　ping www.baidu.com

<img src="/images/http-9.png" alt="http-9.png" />
### 查看互联网协议
<img src="/images/http-10.png" alt="http-10.png" />
### 查看应用层HTTP协议
<img src="/images/http-14.png" alt="http-14.png" />
### 查看传输层TCP协议
<img src="/images/http-11.png" alt="http-11.png" />
### 查看程序对应的PID值
<img src="/images/http-8.png" alt="http-8.png" />
### 查看PID值对应的信息
包括：协议，本地地址，外部地址，状态，PID
<img src="/images/http-7.png" alt="http-7.png" />
## 加密协议，SSL/TLS
TLS（传输层安全协议）
SLL（套接字安全性协议）
协议位置：都处于第五层会话层
<img src="/images/http-13.png" alt="http-13.png">
<img src="/images/http-3.png" alt="http-3.png">


