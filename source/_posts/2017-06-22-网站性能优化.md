---
title: 网站性能优化
date: 2017-06-22 11:59:49
categories: 服务器
tags: 优化
---
## 负载均衡技术
负载均衡技术通过设置虚拟服务器IP（VIP），将后端多台真实服务器的应用资源虚拟成一台高性能的应用服务器，通过负载均衡算法，将大量来自客户端的应用请求分配到后端的服务器进行处理。
各个浏览器同时建立多个持续连接，负载均衡设备持续的对服务器上的应用状态进行检查，并自动对无效的应用服务器进行隔离，实现了一个简单、扩展性强、可靠性高的应用解决方案。解决了单台服务器处理性能不足，扩展性不够，可靠性较低的问题。
## HTTP复用和TCP连接复用区别
TCP连接复用是将多个客户端的HTTP请求复用到一个服务器端TCP连接上，负载均衡设备的独特功能
HTTP复用则是一个客户端的多个HTTP请求通过一个TCP连接进行处理，HTTP1.1协议所支持的新功能
## TCP连接复用
采用TCP连接复用技术后，客户端（如：ClientA）与负载均衡设备之间进行三次握手并发送HTTP请求。负载均衡设备收到请求后，会检测服务器是否存在空闲的长连接，如果不存在，服务器将建立一个新连接。当HTTP请求响应完成后，客户端则与负载均衡设备协商关闭连接，而负载均衡则保持与服务器之间的这个连接。当有其它客户端（如：ClientB）需要发送HTTP请求时，负载均衡设备会直接向与服务器之间保持的这个空闲连接发送HTTP请求，避免了由于新建TCP连接造成的延时和服务器资源耗费。
<img src="/images/http-18.png" alt="http-18.png">

## TCP缓冲
为了解决后端服务器网速与客户的前端网络速度不匹配而造成的服务器资源浪费的问题;
<img src="/images/http-20.png" alt="http-20.png">
1. 负载均衡收到客户端发来的HTTP请求并将其转发给后端的服务器进行处理；
2. 服务器对请求进行处理后，将响应的内容依次返回负载均衡设备，负载均衡设备收到响应的数据包后，会将数据包依次缓存在缓冲区中，服务器的响应速度将依据负载均衡和服务器之间的链路质量；
3. 当负载均衡上缓存了第一个响应的数据包后，负载均衡将响应的数据包按次序返回给客户端，此时，响应的速度将依赖于负载均衡与客户端之间的链路质量；
4. 当响应内容数据包依次传送给客户端并收到客户端的ACK确认请求后，负载均衡将缓冲区资源释放出来为其它TCP连接使用。

## 内容缓存
内容缓存技术将应用服务器中的一些经常被用户访问的热点内容缓存在负载均衡设备的内存中
<img src="/images/http-19.png" alt="http-19.png">
1. 当有客户端发起对logo.gif的第一个请求时，负载均衡首先会检查本地缓存中是否存在该对象。如果不存在这个对象，负载均衡会将这个HTTP请求转发给后端的服务器；
2. 服务器收到对logo.gif的HTTP请求后，将图片内容回应给负载均衡设备；
3. 负载均衡设备将logo.gif对象缓存在内容缓存中，并将其发送给客户端；
4. 后续的其它客户端发起对logo.gif的访问请求时，如果负载均衡检测到内容缓存中已经存在该对象，并确认该对象并未失效的话，负载均衡直接将该对象返回给客户端，而无需服务器再次发送该对象。

## HTTP压缩
压缩算法本身需要耗费大量的CPU资源，因此，负载均衡设备通过对HTTP压缩功能进行支持，减轻Web服务器的资源耗费，提高其处理效率,即使服务器不支持HTTP压缩，通过负载均衡也能实现压缩功能。
<img src="/images/http-21.png" alt="http-21.png">
1. 客户端与负载均衡建立TCP连接后，发送HTTP请求（如Get请求），客户端会将自身浏览器所支持的功能和配置情况发送给负载均衡，如：是否支持压缩、支持的压缩算法、是否支持Keep-alive（连接保持）、连接保持的时间等；
2. 负载均衡在收到HTTP请求后，会将其中的有关压缩的标记删除，然后将请求转发给服务器进行处理；
3. 服务器将响应的内容转发给负载均衡；
4. 负载均衡收到响应的内容后，依照与客户端之间协商的压缩算法对响应的内容进行压缩，然后将压缩后的内容发送回客户端；
5. 客户端收到响应的内容后，由浏览器对网页内容进行解压缩并进行浏览。

## SSL加速
SSL是需要耗费大量CPU资源的一种安全技术。目前，大多数负载均衡设备均采用SSL加速芯片进行SSL信息的处理。这种方式比传统的采用服务器的SSL加密方式提供更高的SSL处理性能，从而节省大量的服务器资源，使服务器能够专注于业务请求的处理。
1. 客户端发起HTTPS连接请求，协商传输的加密算法，确认双方身份，并交换会话密钥。
2. 负载均衡收到客户端加密的HTTPS请求后，对请求的信息进行解密，然后通过HTTP的方式发送给后端的服务器。
3. 服务器将请求的处理结果返回给负载均衡设备。
4. 负载均衡设备利用会话密钥对请求的结果进行加密，然后将结果返回给客户端。
5. 客户端采用会话密钥对返回结果进行解密，并显示在浏览器上。

