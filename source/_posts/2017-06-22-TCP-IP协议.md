---
title: TCP/IP协议
date: 2017-06-22 03:51:02
categories: 服务器
tags: 协议
---
## 关于互联网基础知识，狭义解析
### 链接层:以太网协议（Ethernet）
网卡MAC地址：数据包的发送地址和接收地址
帧：一组电信号构成一个数据包
一帧：标头（18）和数据（46~1500）最短：64字节;最长1518字节;
数据超过一帧长度：分割多个帧发送

### 网络层：IP协议，主要区分不同计算机是否属于同一个子网络；网址对网址
子网掩码：子网络特征的一个参数；两个IP地址与子网掩码分别进行AND运算；得出结果相同则为同子网络采用广播，不相同则采用路由；
广播：向本网络内所有计算机发送
ARP协议：主要获取同子网中计算机的MAC地址
路由：向不同的子网络分发数据包
IP数据包：标头(20~60)和数据(65515),总长65535字节；由于以太网数据包数据部分1500字节，那么分割发送；

### 传输层：TCP、UDP协议，端口对端口
TCP：具有有确认机制的UDP协议，每发出一个数据包都要求确认；
TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割
端口：1024~65535之间的整数


### 应用层：规定应用程序的数据格式（http）
数据包传送：前提条件（对方的MAC地址，对方的IP地址）
http数据包(4960)
-->TCP数据包(4980)
-->IP数据包(开始分割成4个包，每个包占标头20,4980+20*4所以总长5060)
-->四个以太网数据包：1500,1500,1500,560

<img src="/images/http-16.png" alt="http-16.png">
## TCP传输控制协议,位于传输层
`Sequence number`顺序号码(下面简写为：SeqNum) 
`Acknowledge number`确认号码(下面简写为：AckNum)
`SYN`(synchronous)表示建立连接 
`ACK`(acknowledgement)表示响应
`URG`(urgent)表示有紧急的数据传送（URG=1,优先发送紧急数据，并优先提交，比如一个终止命令） 
`PSH`(push)表示推送（PSH=1发送方立即发送缓冲区中的数据，不等待后续数据构成更大的段，接收方立即提交该数据而不等待后续数据的到达） `FIN`(finish)表示关闭连接
`RST`(reset)表示连接重置 
*****
## 三次握手，建立一个连接
<img src="/images/http-4.png" alt="http-4.png"> 
**第一次握手**：客户端发送（`SYN=1`+随机生成的`SeqNum`）数据包到服务器，服务器由`SYN=1`知道客户端要求建立联机；
**第二次握手**：服务器收到请求确认`SYN=1`，就向客户端发送{,`SYN=1`,`ACK=1`,`AckNum(客户端SeqNum+1)`，随机生成的`SeqNum`}数据包
**第三次握手**：客户端收到回应检查(AckNum客户端`SeqNum+1`)是否正确，ACK是否为1，正确则再次发送`AckNum(服务器seqNum+1)`,`ACK=1`,服务器收到后并确认(服务器seqNum+1),ACK=1是否正确； 
**为什么需要三次握手？**
因为请求有可能会丢失和延迟，请求丢失一般采用了超时重传，如果请求并没有丢失而是延迟到达，那么就会出现重复连接，还有一种情况连接关闭后请求才到达，那么会导致服务器一直在等待，从而浪费资源；
*****

## 四次挥手，断开一个连接
<img src="/images/http-5.png" alt="http-5.png">
**第一次挥手**：客户端发送(`FIN=1`+随机生成的`SeqNum`序号)断开连接请求到服务器并等待服务器确认；
**第二次挥手**：服务器确认后发出确认`ACK=1`+`AckNum(SeqNum+1)`包，客户端收到并确认后处于等待状态，等待服务器发送断开请求，此时客户端不再发送数据但可以接受数据；
**第三次挥手**：服务器发送完数据后，接着发送断开请求`FIN=1`;`ACK=1`，`SeqNum`;`AckNum(SeqNum+1)`给客户端；
**第四次挥手**：客户端收到并确认后发送`ACK=1`;`AckNum(SeqNum+1)`确认包给服务器，接着等待M秒（可修改）后关闭连接；服务器收到确认包后也关闭连接；
**为什么采用四次挥手？**
因为单方面断开连接随时可能丢失数据，比如A、B两个主机，A发出断开连接请求并停止接受该连接的数据，那么B没没收到断开连接请求之前随时可能向主机A发送数据，而主机A已经停止接受数据所以会造成数据丢失；所以采用了两个方向上分别断开连接操作，也就是四次挥手；

## 抓包分析
### Wireshark分析工具
wireshark只能查看封包，而不能修改封包的内容，或者发送封包。
**协议过滤**
　　`TCP` `HTTP`
**域名过滤**
　　http.host==hedonglin.com
**IP过滤**
　　ip.addr ==192.168.1.1；显示所有目标或源地址是192.168.1.1；
　　ip.dst==192.168.1.1；显示目标地址是192.168.1.1
　　ip.src ==192.168.1.1 显示源地址是192.168.1.1
**端口过滤**
　　tcp.port ==目标端口80
**请求方法过滤**
　　http.request.method=="GET"
**逻辑运算**
　　and or not
**例子**
　　http and ip.addr == 119.75.216.20 and tcp.port == 80
### 查看域名对应的ip地址
　　ping www.baidu.com

<img src="/images/http-9.png" alt="http-9.png" />
### 查看互联网协议
<img src="/images/http-10.png" alt="http-10.png" />
### 查看应用层HTTP协议
<img src="/images/http-14.png" alt="http-14.png" />
### 查看传输层TCP协议
<img src="/images/http-11.png" alt="http-11.png" />
### 查看程序对应的PID值
<img src="/images/http-8.png" alt="http-8.png" />
### 查看PID值对应的信息
包括：协议，本地地址，外部地址，状态，PID
<img src="/images/http-7.png" alt="http-7.png" />
## 加密协议，SSL/TLS
TLS（传输层安全协议）
SLL（套接字安全性协议）
协议位置：都处于第五层会话层
<img src="/images/http-13.png" alt="http-13.png">
<img src="/images/http-3.png" alt="http-3.png">


